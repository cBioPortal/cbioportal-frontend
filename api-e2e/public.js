const csv = require('csvtojson');
var csvFilePath = './extract-2024-10-11T11_47_07.957Z.csv';

csvFilePath = 'extract-2024-10-13T07_41_15.227Z.csv';

const _ = require('lodash');
const formatCurl = require('format-curl');

var axios = require('axios');
var { runSpecs } = require('./validation');

var exclusions = [/clinical-data-density/, /molecular-profile-sample/];

const cliArgs = parseArgs();

const filters = [];

let hashes = [];

let moos = [
    '631450682',
    '-170204817',
    '-84680704',
    '1658930249',
    '-467367132',
    '-597948398',
    '1388110846',
    '1870729430',
    '1598833781',
    '-599068798',
    '-402825990',
    '-354554418',
    '865669958',
    '-1209690083',
    '-208113473',
    '-1464628952',
    '10650520',
    '-837616318',
    '1224897188',
    '647742526',
    '-1607895776',
    '-2037248745',
    '-1405588921',
    '-1635264016',
    '535693053',
    '434460277',
    '-1423230564',
    '-374643516',
    '-1735129427',
    '-1144748981',
    '-1421775756',
    '1895164916',
    '-253195460',
    '-616389378',
    '-1827897056',
    '1612090123',
    '1325352156',
    '-969783118',
    '-2009624076',
    '60297326',
    '2084799169',
    '-1532898703',
    '753904004',
    '-1252166631',
    '-2105827951',
    '111369452',
    '-208575755',
    '-1970080199',
    '1488562009',
    '-1555792159',
    '-1704732196',
    '836959411',
    '120267065',
    '-1555866989',
    '-216573675',
    '-379194099',
    '1502823827',
    '-1682181446',
    '1625439676',
    '584887943',
    '-2046339096',
    '-1320441691',
    '1270362153',
    '-297626343',
    '288956321',
    '-1899514961',
    '-1413994933',
    '-2113817139',
    '10730406',
    '-1453024695',
    '612255788',
    '1488680884',
    '-1851989700',
    '-390181133',
    '-2136697383',
    '334389772',
    '-1032644814',
    '-2115973194',
    '1451761214',
    '616488583',
    '1532796511',
    '764543886',
    '152983341',
    '-1898646363',
    '-273143411',
    '397284593',
    '-1309800115',
    '-1222068354',
    '506650358',
    '768740376',
    '-400232064',
    '-1978121826',
    '819080985',
    '-276313963',
    '-1047429603',
    '-340093617',
    '-1455231579',
    '382541723',
    '-1565563088',
    '218614389',
    '1966719811',
    '-1958454581',
    '1145384019',
    '343088765',
    '-1588129939',
    '2132110402',
    '-1561576157',
    '576779601',
    '444693209',
    '-1746027935',
    '-1926928885',
    '121378911',
    '-486022668',
    '-2039105743',
    '-1490418048',
    '1910724313',
    '1518916592',
    '-256751414',
    '1637357663',
    '328138572',
    '-1037193116',
    '1321564273',
    '-1539235668',
    '-356115658',
    '-753109349',
    '-2029362889',
    '-1862814243',
    '82293504',
    '939939095',
    '1693730585',
    '724656594',
    '-130897992',
    '1103112135',
    '982465581',
    '-1011106429',
    '202736822',
    '-1842559442',
    '200577571',
    '-1458390145',
    '-546396458',
    '1828531595',
    '-1798942973',
    '1367946397',
    '2115230890',
    '1689773109',
    '-2124788882',
    '-662652911',
    '1719546759',
    '1628835583',
    '1733652599',
    '2048742925',
    '1399496857',
    '-518094403',
    '988999079',
    '105402209',
    '1257904055',
    '924544815',
    '785861799',
    '-416371395',
    '-22365207',
    '1425559309',
    '-1533222441',
    '137437362',
    '919834864',
    '-2128909526',
    '-802253704',
    '-1887514112',
    '-1797990102',
    '-860806010',
    '-85435696',
    '1603872445',
    '545734491',
    '559840331',
    '455023315',
    '874930657',
    '-628945083',
    '1748430953',
    '-184813189',
    '328512254',
    '1685913594',
    '1514308466',
    '-430291840',
    '-1596879638',
    '1056764806',
    '-183787350',
    '74652186',
    '-1931877812',
    '1339043624',
    '-1973858929',
    '-1395582859',
    '100764153',
    '-2082231907',
    '-1959670828',
    '1166700714',
    '437318483',
    '1550547244',
    '-11458668',
    '12386842',
    '438847407',
    '312065672',
    '1461748242',
    '-98020122',
    '1203445222',
    '-772214867',
    '-162451038',
    '1629772334',
    '1654792124',
    '-1023161017',
    '-2074276756',
    '-305101900',
    '2048745056',
    '-262932598',
    '1168983298',
    '-850356102',
    '-1792777678',
    '1061979373',
    '180953340',
    '1411967402',
    '1514094747',
    '1008528915',
    '-1552113269',
    '-1918506884',
    '1035914715',
    '871245308',
    '-1630089717',
    '-199052613',
    '1442340714',
    '-301861134',
    '-306067334',
    '455817433',
    '470830618',
    '590580569',
    '-2008281110',
    '816765258',
    '-1332048013',
    '1921524147',
    '-1932286338',
    '320494144',
    '-1915968482',
    '-1749688380',
    '-1696394053',
    '2095363431',
    '1413082179',
    '-1081770754',
    '-46214137',
    '460740961',
    '-421841122',
    '-103748400',
    '-1055177488',
    '616789385',
    '2062576853',
    '1120647641',
    '-56586020',
    '913376734',
    '1290285048',
    '108965210',
    '-298062277',
    '-1605130239',
    '-353687711',
    '-1897874586',
    '362532139',
    '531398073',
    '243468043',
    '-158049573',
    '-2012157726',
    '-1460380552',
    '295230524',
    '-928349478',
    '1274087004',
    '-917798803',
    '365171977',
    '-1648266611',
    '809096332',
    '-1726100593',
    '-1550469952',
    '-1193263198',
    '-1167921147',
    '-485028167',
    '-310960451',
    '-333794387',
    '-1555192267',
    '936974935',
    '89467101',
    '-1534017795',
    '-807914063',
    '-505694523',
    '643026493',
    '-363435083',
    '-519244572',
    '1142105423',
    '-2073853723',
    '1754667045',
    '2022549510',
    '1080924117',
    '564756833',
    '-29515870',
    '1014223356',
    '1113600170',
    '-1203647954',
    '1982015438',
    '367815258',
    '203998497',
    '-1391593582',
    '-1558930374',
    '255383726',
    '5883073',
    '206427124',
    '1655803502',
    '-308131176',
    '1991656122',
    '826807248',
    '1897851113',
    '1467662069',
    '294516166',
    '1705830623',
    '-551706245',
    '-1757341086',
    '-784782156',
    '1376880251',
    '-219495583',
    '1775617510',
    '2082391880',
    '-1632944843',
    '-1956509288',
    '1313456032',
    '-993032393',
    '-414256740',
    '1060678904',
    '-539785467',
    '-112692260',
    '-1429629149',
    '42243538',
    '1763472544',
    '1853556760',
    '899056493',
    '649214677',
    '-1839313216',
    '1899934755',
    '172324490',
    '-92300264',
    '1500211877',
    '222764274',
    '-1526873185',
    '1179246359',
    '1816938667',
    '887308081',
    '1002976033',
    '-5089684',
    '-1360456087',
    '260489931',
    '1321611027',
    '1758849719',
    '305258284',
    '1820866015',
    '353368767',
    '2145755075',
    '603093751',
    '1072190442',
    '-529859850',
    '-593582122',
    '-757130200',
    '1008873253',
    '-1825470371',
    '384902797',
    '-1022334155',
    '414070496',
    '1515247087',
    '-931775288',
    '-484081529',
    '-1575918947',
    '850049159',
    '-153383241',
    '-1366040891',
    '860720272',
    '308297064',
    '-735124612',
    '-1137827504',
    '-1442353336',
    '-399670681',
    '399046631',
    '-1766839219',
    '1355208558',
    '-1436856030',
    '-1304180033',
    '-349080261',
    '225299066',
    '-382489202',
    '-1066431476',
    '-287554665',
    '-1170750261',
    '1829954231',
    '1871550863',
    '1378473619',
    '174707071',
    '-62742105',
    '433310523',
    '1372413735',
    '-1020381772',
    '-788550390',
    '813654522',
    '-1132061076',
    '-1968597541',
];

moos = [
    '1598833781',
    '-354554418',
    '-599068798',
    '-1209690083',
    '535693053',
    '-374643516',
    '-1144748981',
    '-253195460',
    '1895164916',
    '1612090123',
    '-616389378',
    '1325352156',
    '-969783118',
    '-1532898703',
    '753904004',
    '-1252166631',
    '-2105827951',
    '-1970080199',
    '111369452',
    '-208575755',
    '1488562009',
    '-1704732196',
    '-1555792159',
    '120267065',
    '836959411',
    '-1320441691',
    '1270362153',
    '-1899514961',
    '288956321',
    '-297626343',
    '10730406',
    '-2113817139',
    '-1413994933',
    '-1453024695',
    '612255788',
    '1488680884',
    '-390181133',
    '-2136697383',
    '-1851989700',
    '334389772',
    '616488583',
    '1532796511',
    '1451761214',
    '764543886',
    '152983341',
    '-1898646363',
    '-1309800115',
    '-273143411',
    '397284593',
    '-1222068354',
    '768740376',
    '506650358',
    '-1978121826',
    '819080985',
    '-400232064',
    '-276313963',
    '-340093617',
    '-1047429603',
    '382541723',
    '-1565563088',
    '-1455231579',
    '218614389',
    '1966719811',
    '-1958454581',
    '-1588129939',
    '343088765',
    '1145384019',
    '-1561576157',
    '576779601',
    '2132110402',
    '-1926928885',
    '-1746027935',
    '444693209',
    '-2039105743',
    '121378911',
    '-486022668',
    '-356115658',
    '939939095',
    '82293504',
    '724656594',
    '1693730585',
    '-130897992',
    '982465581',
    '1103112135',
    '202736822',
    '200577571',
    '-1842559442',
    '-546396458',
    '-1458390145',
    '1828531595',
    '2115230890',
    '-662652911',
    '-2124788882',
    '1689773109',
    '1719546759',
    '1733652599',
    '1628835583',
    '2048742925',
    '1399496857',
    '-518094403',
    '105402209',
    '988999079',
    '1257904055',
    '-416371395',
    '785861799',
    '924544815',
    '-1533222441',
    '-22365207',
    '1425559309',
    '137437362',
    '919834864',
    '-2128909526',
    '-1797990102',
    '-802253704',
    '-1887514112',
    '1603872445',
    '-85435696',
    '-860806010',
    '545734491',
    '559840331',
    '455023315',
    '-628945083',
    '874930657',
    '1748430953',
    '328512254',
    '-184813189',
    '1685913594',
    '-430291840',
    '-1596879638',
    '1514308466',
    '74652186',
    '1056764806',
    '-183787350',
    '-1395582859',
    '100764153',
    '-2082231907',
    '-1959670828',
    '1166700714',
    '1461748242',
    '-772214867',
    '-98020122',
    '-162451038',
    '-305101900',
    '-262932598',
    '2048745056',
    '1168983298',
    '1061979373',
    '-1792777678',
    '-850356102',
    '1411967402',
    '1514094747',
    '180953340',
    '-1918506884',
    '-1552113269',
    '1008528915',
    '1035914715',
    '871245308',
    '-1630089717',
    '-199052613',
    '1442340714',
    '-301861134',
    '470830618',
    '455817433',
    '-306067334',
    '816765258',
    '590580569',
    '-2008281110',
    '-1332048013',
    '1413082179',
    '-1081770754',
    '-46214137',
    '460740961',
    '-421841122',
    '-1055177488',
    '616789385',
    '2062576853',
    '1290285048',
    '913376734',
    '362532139',
    '-1897874586',
    '243468043',
    '531398073',
    '295230524',
    '1274087004',
    '-917798803',
    '-928349478',
    '-1648266611',
    '365171977',
    '809096332',
    '-310960451',
    '-485028167',
    '-1167921147',
    '936974935',
    '-1555192267',
    '-333794387',
    '89467101',
    '-807914063',
    '-1534017795',
    '-505694523',
    '-363435083',
    '643026493',
    '-2073853723',
    '-519244572',
    '1142105423',
    '1014223356',
    '-1203647954',
    '1982015438',
    '1113600170',
    '367815258',
    '203998497',
    '-1391593582',
    '-1558930374',
    '255383726',
    '1655803502',
    '1467662069',
    '-414256740',
    '-539785467',
    '1060678904',
    '1763472544',
    '899056493',
    '649214677',
    '1853556760',
    '-1839313216',
    '1899934755',
    '222764274',
    '1500211877',
    '1816938667',
    '-1526873185',
    '-5089684',
    '1002976033',
    '887308081',
    '260489931',
    '-1360456087',
    '1072190442',
    '-1825470371',
    '-153383241',
    '308297064',
    '860720272',
    '-1366040891',
    '-1442353336',
    '-735124612',
    '-1137827504',
    '-1304180033',
    '1355208558',
    '-1436856030',
    '-382489202',
    '225299066',
    '-349080261',
    '-287554665',
    '1871550863',
    '-62742105',
    '-1968597541',
    '813654522',
];

moos = ['111369452'];

hashes = moos.map(s => new RegExp(s));

const START = 0;
const LIMIT = 10000;

async function main() {
    const files = await csv()
        .fromFile(csvFilePath)
        .then(async jsonObj => {
            let uniq = _.uniqBy(jsonObj, '@hash')
                .filter(d => {
                    return _.every(
                        exclusions.map(re => re.test(d['@url']) === false)
                    );
                })
                .filter(d => {
                    return (
                        filters.length === 0 ||
                        _.every(filters.map(re => re.test(d['@url']) === true))
                    );
                })
                .filter(d => {
                    return (
                        hashes.length === 0 ||
                        _.some(hashes.map(re => re.test(d['@hash']) === true))
                    );
                });

            const tests = uniq.slice(START, START + LIMIT).reduce((aggr, d) => {
                try {
                    const url = d['@url']
                        .replace(/^"|"$/g, '')
                        .replace(/^\/\/[^\/]*/, '')
                        .replace(/\/api\//, '/api/column-store/');

                    const label = d['@url']
                        .match(/\/api\/[^\/]*/i)[0]
                        .replace(/\/api\//, '')
                        .split('-')
                        .map(s => s.replace(/^./, ss => ss.toUpperCase()))
                        .join('');

                    aggr.push({
                        hash: d['@hash'],
                        label,
                        data: JSON.parse(d['@data']),
                        url,
                    });
                } catch (err) {
                    console.log(err);
                }
                return aggr;
            }, []);

            // tests.forEach((t)=>{
            //     console.log(t.data.studyIds || t.data.studyViewFilter.studyIds);
            // })

            const fakeFiles = [
                {
                    file: 'fake',
                    suites: [
                        {
                            tests,
                        },
                    ],
                },
            ];

            return fakeFiles;
        });

    runSpecs(
        files,
        axios,
        'http://localhost:8082',
        cliArgs.v ? 'verbose' : '',
        onFail
    );
}

main();

const onFail = args => {
    //console.log(args);

    const url = 'http://localhost:8082' + args.url;
    // const options = {
    //     // headers: {
    //     //     'x-header': 'test',
    //     //     'x-header2': 'test2'
    //     // },
    //     body: JSON.stringify(args.data),
    //     method: 'POST',
    //     //args: ['-vvv']
    // };

    const curl = `
        curl '${url}' 
          -H 'accept: application/json, text/plain, */*' 
          -H 'accept-language: en-US,en;q=0.9' 
          -H 'cache-control: no-cache' 
          -H 'content-type: application/json' 
          -H 'cookie: _ga_ET18FDC3P1=GS1.1.1727902893.87.0.1727902893.0.0.0; _gid=GA1.2.1570078648.1728481898; _ga_CKJ2CEEFD8=GS1.1.1728589307.172.1.1728589613.0.0.0; _ga_5260NDGD6Z=GS1.1.1728612388.318.1.1728612389.0.0.0; _gat_gtag_UA_17134933_2=1; _ga=GA1.1.1260093286.1710808634; _ga_334HHWHCPJ=GS1.1.1728647421.32.1.1728647514.0.0.0' 
          -H 'pragma: no-cache' 
          -H 'priority: u=1, i'  
          -H 'sec-ch-ua: "Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"' 
          -H 'sec-ch-ua-mobile: ?0' 
          -H 'sec-ch-ua-platform: "macOS"' 
          -H 'sec-fetch-dest: empty' 
          -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36' 
          --data-raw '${JSON.stringify(args.data)}';
    `;

    //console.log(url);
    //console.log(JSON.stringify(args.data));

    // console.log(
    //     curl
    //         .trim()
    //         .split('\n')
    //         .join('')
    // );
    //
    // console.log(
    //     `http://localhost:8082/study/summary?id=ov_tcga_pan_can_atlas_2018#filterJson=${encodeURIComponent(
    //         JSON.stringify(args.data)
    //     )}`
    // );
};

function parseArgs() {
    const args = process.argv.slice(2);

    const pairs = args.filter(s => /-[^=]*=[^/\s]/);

    const single = args.filter(s => /-[^/\s]*/);

    const obj = {};

    single.forEach(a => {
        obj[a.replace(/^-/, '')] = true;
    });

    // console.log(pairs);
    // pairs.forEach(p=>{
    //     p.split("=").forEach((vals)=>{
    //         obj[vals[0].replace(/^-/,"")]=vals[1]
    //     })
    // })

    return obj;
}
